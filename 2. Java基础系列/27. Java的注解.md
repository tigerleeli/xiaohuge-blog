### ä¸€ã€æ³¨è§£çš„å®šä¹‰

#### 1.1 é€šç”¨çš„æ³¨è§£å£°æ˜æ–¹å¼

```java
public @interface æ³¨è§£å {
    //å®šä¹‰æˆå‘˜
}
```

- é€šè¿‡ `@`interface è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ³¨è§£æ¥å£ï¼›
- æ³¨è§£ä¸­çš„æˆå‘˜å˜é‡åœ¨æ³¨è§£å£°æ˜ä¸­ä»¥æ— å‚æ•°æ–¹æ³•çš„å½¢å¼æ¥å£°æ˜ï¼Œå…¶æ–¹æ³•åå®šä¹‰äº†è¯¥æˆå‘˜çš„åå­—ï¼Œè¿”å›å€¼å®šä¹‰äº†è¯¥æˆå‘˜çš„ç±»å‹ï¼Œæ³¨è§£ä¸­æˆå‘˜å˜é‡çš„ç±»å‹æ˜¯å—é™åˆ¶çš„ï¼Œåªèƒ½æ˜¯åŸºæœ¬ç±»å‹åŠå…¶åŒ…è£…ç±»ã€Stringç±»å‹ã€Classç±»å‹ã€æšä¸¾ç±»å‹ã€æ³¨è§£ç±»å‹ã€ä»¥åŠè¿™äº›ç±»å‹çš„æ•°ç»„ã€‚

#### 1.2 ä½¿ç”¨å…ƒæ³¨è§£å®šä¹‰æ³¨è§£

åœ¨å®šä¹‰æ³¨è§£æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å…ƒæ³¨è§£ @Retentionã€@Targetã€@Inherited å’Œ @Documented è¯´æ˜æ³¨è§£çš„ä½œç”¨åŸŸã€ä½¿ç”¨èŒƒå›´ã€æ˜¯å¦å¯ç»§æ‰¿å’Œæ˜¯å¦è¾“å‡ºåˆ° API æ–‡æ¡£ä¸­ã€‚

```java
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Target(ElementType.TYPE)
@Documented
public @interface MyAnnotation {
    String name() default "default";
}
```

- "@Retention"è¡¨ç¤ºä¿ç•™æœŸï¼Œå®ƒçš„å€¼å®šä¹‰äº†è¯¥æ³¨è§£çš„ç”Ÿå‘½å‘¨æœŸã€‚RetentionPolicy.RUNTIME è¡¨ç¤ºåœ¨è¿è¡Œæ—¶å¯ä»¥è·å–æ³¨è§£ä¿¡æ¯ï¼›
- "@Target" è¡¨ç¤ºé€‚ç”¨èŒƒå›´ï¼Œå¯ä»¥æŒ‡å®šä½œç”¨åœ¨æ³¨è§£ä¸Šçš„ç›®æ ‡å…ƒç´ ç±»å‹ï¼Œå¦‚ç±»ã€æ–¹æ³•ã€æˆå‘˜å˜é‡ç­‰ã€‚å¤šä¸ªç›®æ ‡ç±»å‹å¯ä»¥ç”¨é€—å·éš”å¼€ï¼Œå¦‚æœçœç•¥è¯¥å…ƒç´ ï¼Œè¡¨ç¤ºå®šä¹‰çš„æ³¨è§£å¯ä»¥ç”¨åœ¨æ‰€æœ‰çš„ç¨‹åºå…ƒç´ ä¸Šã€‚
- "@Inherited" è¡¨ç¤ºæ³¨è§£å¯ä»¥è¢«ç»§æ‰¿ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ³¨è§£ä¸ä¼šè¢«ç»§æ‰¿ã€‚å¦‚æœæ³¨è§£éœ€è¦è¢«å­ç±»ç»§æ‰¿ï¼Œå¯ä»¥åœ¨å®šä¹‰æ³¨è§£æ—¶ä½¿ç”¨ @Inherited å…ƒæ³¨è§£ã€‚
- "@Documented" è¡¨ç¤ºæ³¨è§£ä¸­çš„å…ƒç´ å¯ä»¥è¢« javadoc å·¥å…·è¯»å–å¹¶ç”Ÿæˆæ–‡æ¡£ã€‚


##### 1. @Retention

@Retention æ³¨è§£æŒ‡å®šäº†è¢«ä¿®é¥°çš„æ³¨è§£ä¿ç•™å¤šé•¿æ—¶é—´ã€‚

@Retention å±æ€§å–å€¼å¦‚ä¸‹ï¼š

- RetentionPolicy.SOURCEï¼šæ³¨è§£åªå­˜åœ¨äºç¼–è¯‘å™¨å¤„ç†æœŸé—´ï¼Œä¸ä¼šåœ¨ç¼–è¯‘è¾“å‡ºçš„ class æ–‡ä»¶ä¸­å‡ºç°ï¼Œé€‚ç”¨äºé™åˆ¶ç¨‹åºå‘˜ç¼–å†™ä»£ç æ—¶ä½¿ç”¨çš„æ³¨è§£ã€‚
- RetentionPolicy.CLASSï¼šæ³¨è§£ä¼šè¢«ç¼–è¯‘å™¨è®°å½•åœ¨ class æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ JVM ä¸ä¼šä¿ç•™ï¼Œé€‚ç”¨äºéœ€åå°„è·å–æ³¨è§£ä¿¡æ¯çš„æƒ…å†µã€‚
- RetentionPolicy.RUNTIMEï¼šæ³¨è§£ä¼šè¢«ç¼–è¯‘å™¨è®°å½•åœ¨ class æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶åœ¨ JVM è¿è¡Œæ—¶ä¹Ÿä¼šä¿ç•™ï¼Œå¯ä»¥é€šè¿‡åå°„åŠ¨æ€è·å–æ³¨è§£ä¿¡æ¯ã€‚

##### 2. @Target

@Target æ³¨è§£æŒ‡å®šäº†æ³¨è§£å¯ä»¥è¢«ç”¨æ¥ä¿®é¥°å“ªäº›ç¨‹åºå…ƒç´ ï¼Œä¾‹å¦‚ç±»ã€æ–¹æ³•ã€åŸŸç­‰ã€‚

@Target çš„å–å€¼ç±»å‹æœ‰ä»¥ä¸‹å¸¸é‡ï¼š

- ElementType.TYPEï¼šç”¨äºæ ‡æ³¨ç±»ã€æ¥å£ã€æšä¸¾ã€‚
- ElementType.CONSTRUCTORï¼šç”¨äºæ ‡æ³¨æ„é€ æ–¹æ³•ã€‚
- ElementType.FIELDï¼šç”¨äºæ ‡æ³¨æˆå‘˜å˜é‡ã€‚
- ElementType.METHODï¼šç”¨äºæ ‡æ³¨æ–¹æ³•ã€‚
- ElementType.PARAMETERï¼šç”¨äºæ ‡æ³¨å‚æ•°ã€‚
- ElementType.LOCAL_VARIABLEï¼šç”¨äºæ ‡æ³¨å±€éƒ¨å˜é‡ã€‚
- ElementType.ANNOTATION_TYPEï¼šç”¨äºæ ‡æ³¨æ³¨è§£ã€‚
- ElementType.PACKAGEï¼šç”¨äºæ ‡æ³¨åŒ…ã€‚

##### 3. @Inherited

@Inherited æ³¨è§£è¡¨ç¤ºæ ‡æ³¨äº†æ­¤æ³¨è§£çš„ç±»çš„å­ç±»ä¹Ÿä¼šè¢«æ ‡æ³¨æ­¤æ³¨è§£ã€‚

##### 4. @Documented

@Documented æ³¨è§£ä¹Ÿè¢«ç§°ä¸ºæ–‡æ¡£åŒ–æ³¨è§£ï¼ŒåŠ ä¸Šè¿™ä¸ªæ³¨è§£åï¼Œæ³¨è§£çš„ä¿¡æ¯å°±å¯ä»¥è¢« javadoc æ‰€è§£æã€‚


#### 1.3 æ³¨è§£ä¸­çš„æˆå‘˜

æ³¨è§£ä¸­çš„æˆå‘˜å¯ä»¥ä½¿ç”¨ default å…³é”®å­—æŒ‡å®šé»˜è®¤å€¼ã€‚

```java
@Target(ElementType.METHOD)
@Documented
@Retention(RetentionPolicy.RUNTIME)
public @interface MethodInfo {
    String name() default "TestMethod";
    String data() default "2020-05-10";
    int id() default 0;
}
```

nameã€dataã€id éƒ½æ˜¯æ³¨è§£ä¸­çš„æˆå‘˜å˜é‡ï¼Œåœ¨æ³¨è§£ä½¿ç”¨æ—¶éƒ½å¯ä»¥ä½¿ç”¨è¿™äº›æˆå‘˜å˜é‡æ¥å¯¹æ³¨è§£è¿›è¡Œèµ‹å€¼ã€‚

### äºŒã€ä½¿ç”¨æ³¨è§£

#### 2.1 æ³¨è§£çš„è§£æ

å¯ä»¥é€šè¿‡åå°„æœºåˆ¶è·å–åˆ°æŒ‡å®šç±»æˆ–æ–¹æ³•ä¸Šçš„æ³¨è§£ä¿¡æ¯ã€‚

```java
public class RunMyAnnotation {

    @MethodInfo(id=1,name = "Main",data="2022-08-22",value="")
    public void test1(){
        System.out.println("test1");
    }

    public static void main(String[] args) {
        try {
            Method method = RunMyAnnotation.class.getMethod("test1");
            MethodInfo annotation = method.getAnnotation(MethodInfo.class);
            System.out.println("id: " + annotation.id());
            System.out.println("name: " + annotation.name());
            System.out.println("data: " + annotation.data());
            System.out.println("value: " + annotation.value());
        } catch (NoSuchMethodException e) {
            e.printStackTrace();
        }
    }
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½¿ç”¨äº†åå°„æœºåˆ¶è·å–åˆ°æŒ‡å®šç±»ä¸­æŒ‡å®šæ–¹æ³•çš„æ³¨è§£ä¿¡æ¯ã€‚

#### 2.2 ç»™æ³¨è§£èµ‹å€¼

æ³¨è§£ä¸­æˆå‘˜çš„èµ‹å€¼ï¼Œå¯ä»¥ä½¿ç”¨â€œæˆå‘˜å=å€¼â€çš„æ–¹å¼è¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæˆå‘˜éœ€è¦èµ‹å€¼ï¼Œå¹¶ä¸”æˆå‘˜åç§°ä¸º"value"ï¼Œé‚£ä¹ˆåœ¨èµ‹å€¼æ—¶ï¼Œå¯ä»¥çœç•¥æˆå‘˜åç§°å’Œâ€œ=â€ã€‚

- æŒ‡å®šå˜é‡åè¿›è¡Œèµ‹å€¼ï¼š

```java
@MethodInfo(name="sayHello")
public void say(){
    System.out.println("Hello Annotation");
}
```

- åªæœ‰ä¸€ä¸ªé»˜è®¤å€¼'value'è¿›è¡Œèµ‹å€¼ï¼š

```java
@MethodInfo("HelloWord!")
public void say(){
    System.out.println("Hello Annotation");
}
```

#### 2.3 ç¼–è¯‘æ—¶æ³¨è§£å¤„ç†å™¨

Java æä¾›äº† apt å·¥å…·æ¥å¤„ç†æ³¨è§£ï¼ŒApt æ˜¯ Annotation Processing Tool çš„ç¼©å†™ã€‚å®ƒæ˜¯è´Ÿè´£åœ¨ç¼–è¯‘æœŸæ‰«æå’Œå¤„ç†ç±»çš„æ³¨è§£çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æä¾›æ³¨é‡Šå¤„ç†å™¨æœåŠ¡çš„ç¨‹åºã€‚

apt åœ¨ Eclipse å’Œ IDEA ä¸­çš„é»˜è®¤è®¾ç½®æ˜¯å…³é—­çš„ï¼Œéœ€è¦è¿›è¡Œé…ç½®ã€‚

#### 2.4 è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨

æ³¨è§£å¤„ç†å™¨çš„å·¥ä½œå°±æ˜¯æ‰«ææºä»£ç ä¸­çš„æ³¨è§£ï¼Œå¹¶è§£æå’Œä½¿ç”¨æ³¨è§£ã€‚

è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨ä¸€èˆ¬åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š

- æ³¨è§£å£°æ˜ç±»å‹ï¼›
- æ³¨è§£å¤„ç†ç±»ã€‚

â€‹ ä»¥ @BindView æ³¨è§£ä¸ºä¾‹å­ï¼š

##### 2.4.1 å®šä¹‰æ³¨è§£ @BindView

```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface BindView {
    int value();
}
```

è¿™ä¸ªæ³¨è§£ç”¨äºè®¾ç½®æ§ä»¶çš„ IDï¼Œå®ƒåªèƒ½ç”¨äºæˆå‘˜å˜é‡ï¼Œä½œç”¨åŸŸæ˜¯è¿è¡Œæ—¶ã€‚

##### 2.4.2 è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨

è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨éœ€è¦ç»§æ‰¿ javax.annotation.processing.AbstractProcessor æŠ½è±¡ç±»å¹¶ä¸”è¦†å†™å¤„ç†æ³¨è§£çš„æ–¹æ³•ã€‚

```java
@SupportedAnnotationTypes("com.yuk.customannotaion.BindView")
@SupportedSourceVersion(SourceVersion.RELEASE_8)
public class MyAnnotationProcessor extends AbstractProcessor {
    @Override
    public boolean process(Set<? extends TypeElement> set, RoundEnvironment roundEnvironment) {
        System.out.println("è¿›å…¥æ³¨è§£å¤„ç†å™¨");

        // è·å–åˆ°æ³¨è§£@BindView
        Set<? extends Element> es = roundEnvironment.getElementsAnnotatedWith(BindView.class);
        for (Element e : es) {
            // å¼ºè½¬æˆå˜é‡å…ƒç´ 
            VariableElement ve = (VariableElement) e;
            // è·å–å˜é‡å…ƒç´ æ‰€åœ¨çš„ç±»
            TypeElement enclosingElement = (TypeElement) ve.getEnclosingElement();
            // è·å–ç±»åå’ŒåŒ…å
            String packageName = elementUtils.getPackageOf(enclosingElement).getQualifiedName().toString();
            String className = enclosingElement.getSimpleName().toString();
            // æ§ä»¶ID
            int id = ve.getAnnotation(BindView.class).value();
            // æ§ä»¶åç§°
            String fieldName = ve.getSimpleName().toString();
            System.out.println(String.format("packageName=%s, className=%s, fieldName=%s, id=%d", packageName, className, fieldName, id));
        }
        System.out.println("é€€å‡ºæ³¨è§£å¤„ç†å™¨");
        return true;
    }
}
```

#### 2.5 ä½¿ç”¨ apt å·¥å…·è§£ææ³¨è§£

åœ¨æ³¨è§£å¤„ç†å™¨å®Œæˆåï¼Œéœ€è¦é€šè¿‡ apt å·¥å…·æŠŠæ³¨è§£å¤„ç†å™¨ç¼–è¯‘å¹¶ç”Ÿæˆå¤„ç†ç»“æœï¼Œå¹¶åœ¨è¿è¡Œæ—¶è¢«è§£æã€‚

##### 2.5.1 ç¼–è¯‘æ³¨è§£å¤„ç†å™¨

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘æ³¨è§£å¤„ç†å™¨ï¼š

```bash
javac -encoding UTF-8 MyAnnotationProcessor.java
```

ä¹‹åä¼šç”Ÿæˆ MyAnnotationProcessor.class æ–‡ä»¶ã€‚

##### 2.5.2 ä½¿ç”¨ apt å·¥å…·è§£ææ³¨è§£

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘åŒ…å« @BindView æ³¨è§£çš„ç±»ï¼š

```bash
javac -processor com.xxx.xxx.MyAnnotationProcessor TestAnnotation.java
```

åœ¨ç¼–è¯‘æ—¶ï¼ŒApt ä¼šæ‰«æ @BindView æ³¨è§£å¹¶è°ƒç”¨ @BindView æ³¨è§£å¤„ç†å™¨ç”Ÿæˆç›¸åº”çš„ä»£ç ï¼Œç”Ÿæˆçš„ä»£ç å°±æ˜¯æŠŠ @BindView æ³¨è§£çš„å­—æ®µå’Œæ§ä»¶IDç»‘å®šèµ·æ¥çš„ä»£ç ã€‚

å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šâ€œå°è™å“¥çš„æŠ€æœ¯åšå®¢â€ã€‚æˆ‘ä»¬ä¼šå®šæœŸå‘å¸ƒå…³äºJavaæŠ€æœ¯çš„è¯¦å°½æ–‡ç« ï¼Œè®©æ‚¨èƒ½å¤Ÿæ·±å…¥äº†è§£è¯¥é¢†åŸŸçš„å„ç§æŠ€å·§å’Œæ–¹æ³•ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æˆä¸ºæ›´ä¼˜ç§€çš„ç¨‹åºå‘˜ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»ï¼