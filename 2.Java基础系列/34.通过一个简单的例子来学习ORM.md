## ä»€ä¹ˆæ˜¯ORM
ORMï¼ˆObject-Relational Mappingï¼‰æ˜¯ä¸€ç§å°†é¢å‘å¯¹è±¡ç¨‹åºæ•°æ®æ¨¡å‹ä¸å…³ç³»æ•°æ®åº“ä¹‹é—´è¿›è¡Œæ˜ å°„çš„æŠ€æœ¯ã€‚

æ¯”å¦‚æ•°æ®åº“è¡¨userï¼Œå®ƒæœ‰idã€nameã€ageå­—æ®µæ˜ å°„åˆ°Javaå®ä½“ç±»å°±æ˜¯Userç±»ï¼Œæœ‰idã€nameã€ageå±æ€§ã€‚
```sql
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(20) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `age` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

```java
@Entity
@Table(name = "user")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String name;
    private int age;

    // çœç•¥setterå’Œgetter
}
```
## ä»€ä¹ˆæ˜¯JPA
JPAï¼ˆJava Persistence APIï¼‰(JavaæŒä¹…åŒ–æ¥å£)æ˜¯Javaå¹³å°æä¾›çš„ä¸€å¥—æ ‡å‡†åŒ–çš„æŒä¹…åŒ–æ¡†æ¶ï¼Œç”¨äºç®€åŒ–Javaå¯¹è±¡ä¸æ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚

JPAå¸®ä½ éšè—äº†åº•å±‚æ•°æ®åº“ç»†èŠ‚ï¼Œä½ åªéœ€è¦æ“ä½œå¯¹è±¡ï¼Œè€Œä¸éœ€è¦ç¼–å†™å¤æ‚çš„SQLè¯­å¥ï¼ŒJPAä¼šå¸®ä½ è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„SQLè¯­å¥å¹¶æ‰§è¡Œã€‚

å…¶å®JPAå°±æ˜¯å¸®æˆ‘å®šä¹‰å¥½äº†ä¸€ç³»åˆ—æ³¨è§£ï¼Œå®ƒä¸æä¾›å…·ä½“çš„å®ç°ï¼Œåªæ˜¯å®šè§„èŒƒã€‚å¦‚ä¸‹ï¼š
![](https://files.mdnice.com/user/33663/4a826915-0247-4a20-9741-f17faeafa280.png)

ä¸‹é¢è¿™äº›æ³¨è§£æ˜¯å¦å¾ˆç†Ÿæ‚‰
```java
@Documented
@Target(TYPE)
@Retention(RUNTIME)
public @interface Entity {

	String name() default "";
}


public @interface OneToMany {

    Class targetEntity() default void.class;

    CascadeType[] cascade() default {};

    FetchType fetch() default LAZY;

    String mappedBy() default "";

    boolean orphanRemoval() default false;
}

@Target({METHOD, FIELD}) 
@Retention(RUNTIME)
public @interface Column {

    String name() default "";

    boolean unique() default false;

    boolean nullable() default true;

    boolean insertable() default true;

    boolean updatable() default true;
    
    String columnDefinition() default "";
    
    String table() default "";

    int length() default 255;
    
    int precision() default 0;

    int scale() default 0;
}
```
å°±æ˜¯JPAåªå®šä¹‰æ¥å£è§„èŒƒï¼Œå…·ä½“æ€ä¹ˆå®ç°å„ä¸ªå‚å®¶è‡ªå·±å»åšï¼Œä»¥ä¸‹æ˜¯åŸºäºJPAçš„å¸¸ç”¨çš„æ¡†æ¶ã€‚
- Hibernate
- OpenJPA
- Spring Data JPA

## è‡ªå·±å°è£…ä¸€ä¸ªORMæ¡†æ¶
ä¸‹é¢é€šè¿‡ä¸€ä¸ªä»£ç ç¤ºä¾‹æ¥è‡ªå·±å°è£…ä¸€ä¸ªç®€å•çš„ORMæ¡†æ¶ã€‚

å¼•å…¥ä¾èµ–åŒ…ï¼Œå°±æ˜¯mysql-connector-javaå’Œjavax.persistence-api
```xml
<dependencies>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.33</version>
    </dependency>

    <dependency>
        <groupId>javax.persistence</groupId>
        <artifactId>javax.persistence-api</artifactId>
        <version>2.2</version>
    </dependency>
</dependencies>
```


---
å¦‚ä¸‹æ˜¯JDBCè·å–æ•°æ®åº“è¿æ¥

```java
import java.sql.Connection;
import java.sql.DriverManager;

public class ConnectionUtil {

    public static Connection getConnection() throws Exception {
        String url = "jdbc:mysql://localhost:3306/jdbc_orm?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false";
        String user = "root";
        String password = "123456";
        return DriverManager.getConnection(url, user, password);
    }
}
```
---
å…·ä½“çš„ORMæ ¸å¿ƒä»£ç ï¼Œç”¨Javaçš„åå°„æŠ€æœ¯æ¥å®ç°ã€‚

```java
import javax.persistence.Entity;
import javax.persistence.Id;
import java.lang.reflect.Field;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;

public class OrmUtil {

    private final Connection connection;

    public OrmUtil(Connection connection) {
        this.connection = connection;
    }

    public <T> void save(T entity) throws Exception {
        // è·å–å®ä½“å¯¹è±¡çš„Classå¯¹è±¡
        Class<?> clazz = entity.getClass();
        // è·å–å®ä½“å¯¹è±¡æ‰€å¯¹åº”çš„æ•°æ®åº“è¡¨å
        String tableName = getTableName(clazz);
        // å­˜å‚¨å®ä½“å¯¹è±¡çš„åˆ—åå’Œå¯¹åº”çš„å€¼
        List<String> columns = new ArrayList<>();
        List<Object> values = new ArrayList<>();

        // è·å–å®ä½“å¯¹è±¡çš„å­—æ®µ
        Field[] fields = clazz.getDeclaredFields();
        for (Field field : fields) {
            // è®¾ç½®å­—æ®µå¯è®¿é—®
            field.setAccessible(true);
            // å­˜å‚¨å­—æ®µå
            columns.add(field.getName());
            // å­˜å‚¨å­—æ®µå€¼ï¼Œç”±äºæ˜¯Objectç±»å‹ï¼Œéœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢
            values.add(field.get(entity));
        }

        // æ„å»ºSQLè¯­å¥
        StringBuilder sqlBuilder = new StringBuilder();
        sqlBuilder.append("INSERT INTO ").append(tableName).append(" (");
        for (int i = 0; i < columns.size(); i++) {
            sqlBuilder.append(columns.get(i));
            if (i < columns.size() - 1) {
                sqlBuilder.append(", ");
            }
        }
        sqlBuilder.append(") VALUES (");
        for (int i = 0; i < values.size(); i++) {
            sqlBuilder.append("?");
            if (i < values.size() - 1) {
                sqlBuilder.append(", ");
            }
        }
        sqlBuilder.append(")");
        String sql = sqlBuilder.toString();

        // æ‰“å°SQLè¯­å¥
        System.out.println("æ‰§è¡Œæ–°å¢è¯­å¥ï¼›" + sql);

        // æ‰§è¡ŒSQLè¯­å¥
        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            for (int i = 0; i < values.size(); i++) {
                // è®¾ç½®å‚æ•°ï¼Œç”±äºå‚æ•°ç±»å‹ä¸ç¡®å®šï¼Œä½¿ç”¨setObjectæ–¹æ³•
                statement.setObject(i + 1, values.get(i));
            }
            statement.executeUpdate();
        }
    }

    public <T> void update(T entity) throws Exception {
        // è·å–å®ä½“å¯¹è±¡çš„Classå¯¹è±¡
        Class<?> clazz = entity.getClass();
        // è·å–å®ä½“å¯¹è±¡æ‰€å¯¹åº”çš„æ•°æ®åº“è¡¨å
        String tableName = getTableName(clazz);
        // å­˜å‚¨å®ä½“å¯¹è±¡çš„éä¸»é”®åˆ—åå’Œå¯¹åº”çš„å€¼
        List<String> columns = new ArrayList<>();
        List<Object> values = new ArrayList<>();
        // å­˜å‚¨ä¸»é”®å€¼
        Object idValue = null;

        // è·å–å®ä½“å¯¹è±¡çš„å­—æ®µ
        Field[] fields = clazz.getDeclaredFields();
        for (Field field : fields) {
            // è®¾ç½®å­—æ®µå¯è®¿é—®
            field.setAccessible(true);
            // åˆ¤æ–­å­—æ®µæ˜¯å¦æœ‰@Idæ³¨è§£ï¼Œè‹¥æœ‰ï¼Œåˆ™å°†å…¶å€¼ä½œä¸ºä¸»é”®å€¼å­˜å‚¨
            if (field.isAnnotationPresent(Id.class)) {
                idValue = field.get(entity);
            } else {
                // è‹¥æ²¡æœ‰@Idæ³¨è§£ï¼Œåˆ™å°†å…¶åˆ—åå’Œå€¼å­˜å‚¨
                columns.add(field.getName());
                values.add(field.get(entity));
            }
        }

        // æ„å»ºSQLè¯­å¥
        StringBuilder sqlBuilder = new StringBuilder();
        sqlBuilder.append("UPDATE ").append(tableName).append(" SET ");
        for (int i = 0; i < columns.size(); i++) {
            sqlBuilder.append(columns.get(i)).append(" = ?");
            if (i < columns.size() - 1) {
                sqlBuilder.append(", ");
            }
        }
        sqlBuilder.append(" WHERE id = ?");
        String sql = sqlBuilder.toString();

        System.out.println("æ‰§è¡Œæ›´æ–°è¯­å¥ï¼›" + sql);

        // æ‰§è¡ŒSQLè¯­å¥
        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            for (int i = 0; i < values.size(); i++) {
                // è®¾ç½®éä¸»é”®åˆ—çš„å‚æ•°å€¼
                statement.setObject(i + 1, values.get(i));
            }
            // è®¾ç½®ä¸»é”®å‚æ•°å€¼
            statement.setObject(values.size() + 1, idValue);
            statement.executeUpdate();
        }
    }

    public void delete(Class<?> clazz, Object id) throws Exception {
        // è·å–å®ä½“å¯¹è±¡æ‰€å¯¹åº”çš„æ•°æ®åº“è¡¨å
        String tableName = getTableName(clazz);
        // æ„å»ºSQLè¯­å¥
        String sql = "DELETE FROM " + tableName + " WHERE id = ?";
        System.out.println("æ‰§è¡Œåˆ é™¤è¯­å¥:" + sql);

        // æ‰§è¡ŒSQLè¯­å¥
        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            // è®¾ç½®å‚æ•°å€¼
            statement.setObject(1, id);
            // æ‰§è¡Œåˆ é™¤æ“ä½œ
            statement.executeUpdate();
        }
    }

    public <T> T findById(Class<T> clazz, Object id) throws Exception {
        // è·å–å®ä½“å¯¹è±¡æ‰€å¯¹åº”çš„æ•°æ®åº“è¡¨å
        String tableName = getTableName(clazz);
        // æ„å»ºSQLè¯­å¥
        String sql = "SELECT * FROM " + tableName + " WHERE id = ?";

        System.out.println("æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼›" + sql);

        // æ‰§è¡ŒSQLæŸ¥è¯¢
        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            // è®¾ç½®å‚æ•°å€¼
            statement.setObject(1, id);
            // æ‰§è¡ŒæŸ¥è¯¢æ“ä½œå¹¶è·å–ç»“æœé›†
            try (ResultSet resultSet = statement.executeQuery()) {
                // å¦‚æœæœ‰ç»“æœï¼Œåˆ™åˆ›å»ºå®ä½“å¯¹è±¡å¹¶è®¾ç½®å­—æ®µå€¼
                if (resultSet.next()) {
                    T entity = clazz.newInstance();
                    Field[] fields = clazz.getDeclaredFields();
                    for (Field field : fields) {
                        field.setAccessible(true);
                        // æ ¹æ®å­—æ®µåä»ç»“æœé›†ä¸­è·å–å¯¹åº”çš„å€¼ï¼Œå¹¶è®¾ç½®åˆ°å®ä½“å¯¹è±¡ä¸­
                        Object value = resultSet.getObject(field.getName());
                        field.set(entity, value);
                    }
                    return entity;
                }
            }
        }
        return null;
    }

    private String getTableName(Class<?> clazz) {
        // åˆ¤æ–­ç±»æ˜¯å¦æœ‰@Entityæ³¨è§£
        if (clazz.isAnnotationPresent(Entity.class)) {
            // è·å–ç±»ä¸Šçš„@Entityæ³¨è§£å¯¹è±¡
            Entity entityAnnotation = clazz.getAnnotation(Entity.class);
            // è·å–æ³¨è§£ä¸­çš„è¡¨å
            String tableName = entityAnnotation.name();
            // å¦‚æœæ³¨è§£ä¸­çš„è¡¨åä¸ºç©ºï¼Œåˆ™å°†ç±»åè½¬æ¢ä¸ºå°å†™ä½œä¸ºè¡¨å
            if (tableName.isEmpty()) {
                tableName = clazz.getSimpleName().toLowerCase();
            }
            return tableName;
        }
        // å¦‚æœç±»æ²¡æœ‰@Entityæ³¨è§£ï¼ŒæŠ›å‡ºå¼‚å¸¸
        throw new IllegalArgumentException("ç±»æ²¡æœ‰@Entityæ³¨è§£");
    }
}
```
è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰å·¥å…·ç±»ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨å…¶æä¾›çš„saveã€updateã€deleteã€findByIdç­‰æ–¹æ³•ï¼Œå®ç°å¯¹æ•°æ®åº“è¡¨çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œã€‚

åœ¨è¿™æ®µä»£ç ä¸­ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š

1. é€šè¿‡åå°„è·å–ç±»çš„å±æ€§ã€æ–¹æ³•å’Œæ³¨è§£ç­‰ä¿¡æ¯ï¼›

2. é€šè¿‡PreparedStatementå®ç°å¯¹æ•°æ®åº“çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œï¼›

3. å¯¹Javaæ³›å‹æœºåˆ¶çš„è¿ç”¨ï¼Œå¦‚åœ¨saveã€updateã€findByIdç­‰æ–¹æ³•ä¸­ï¼Œå°†ç±»åå’Œä¸»é”®å€¼ç­‰ä½œä¸ºæ–¹æ³•å‚æ•°ï¼Œä»¥è¾¾åˆ°é€šç”¨çš„æ•ˆæœï¼›

4. å¯¹JPAæ³¨è§£çš„è¿ç”¨ï¼Œå¦‚å¯¹@Idã€@Entityç­‰æ³¨è§£çš„è§£æã€è·å–æ³¨è§£å€¼ç­‰æ“ä½œã€‚
---
æµ‹è¯•å¢åˆ æ”¹æŸ¥
```java
import java.sql.Connection;

public class Test {

    public static void main(String[] args) {
        try {
            // è·å–æ•°æ®åº“è¿æ¥
            Connection connection = ConnectionUtil.getConnection();

            // åˆ›å»ºä¸€ä¸ªå®ä½“ç®¡ç†å™¨
            OrmUtil ormUtil = new OrmUtil(connection);

            // åˆ›å»ºä¸€ä¸ªUserå¯¹è±¡
            User user = new User();
            user.setId(1);
            user.setName("å¼ ä¸‰");
            user.setAge(28);

            // ä¿å­˜Userå¯¹è±¡åˆ°æ•°æ®åº“
            ormUtil.save(user);

            // ä¿®æ”¹Userå¯¹è±¡
            user.setAge(30);
            ormUtil.update(user);

            // æ ¹æ®idæŸ¥è¯¢Userå¯¹è±¡
            User foundUser = ormUtil.findById(User.class, 1);
            System.out.println("æŸ¥è¯¢ç»“æœï¼š"+foundUser); // è¾“å‡ºï¼š"å¼ ä¸‰"

            // åˆ é™¤Userå¯¹è±¡
            ormUtil.delete(User.class, 1);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
## ç»“è¯­

ä»¥ä¸Šåªæ˜¯æœ€ç®€å•çš„å¢åˆ æ”¹æŸ¥ï¼Œå®é™…çš„ORMæ¡†æ¶å¦‚Hibernateçš„åŸç†éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œåªæ˜¯æä¾›çš„å¢åˆ æ”¹æŸ¥çš„æ¥å£æ›´å¤šæ›´ä¸°å¯Œã€‚è¿˜æ˜¯è¦å¯¹Javaçš„åå°„è¿ç”¨è¦æ·±å…¥ã€‚

å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šâ€œå°è™å“¥çš„æŠ€æœ¯åšå®¢â€ã€‚æˆ‘ä»¬ä¼šå®šæœŸå‘å¸ƒå…³äºJavaæŠ€æœ¯çš„è¯¦å°½æ–‡ç« ï¼Œè®©æ‚¨èƒ½å¤Ÿæ·±å…¥äº†è§£è¯¥é¢†åŸŸçš„å„ç§æŠ€å·§å’Œæ–¹æ³•ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æˆä¸ºæ›´ä¼˜ç§€çš„ç¨‹åºå‘˜ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»ï¼
