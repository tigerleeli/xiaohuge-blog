å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦é¢‘ç¹åœ°è¯»å–å’Œå†™å…¥æ•°æ®æ—¶ï¼Œä¸ºäº†æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ç¼“å­˜æŠ€æœ¯ã€‚Spring Boot æä¾›äº†ä¸€ç§ç®€å•è€Œå¼ºå¤§çš„ç¼“å­˜æ¡†æ¶ï¼Œå®ƒå¯ä»¥è½»æ¾åœ°å°†æ•°æ®ç¼“å­˜åˆ° Redis ä¸­ã€‚

åœ¨ Spring Boot ä¸­å¯ä»¥åœ¨æ–¹æ³•ä¸Šç®€å•çš„åŠ ä¸Šæ³¨è§£å®ç°ç¼“å­˜ã€‚

## Redis ç¼“å­˜é…ç½®

é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨æ‚¨çš„é¡¹ç›®ä¸­æ·»åŠ  Redis çš„ä¾èµ–ã€‚æ‚¨å¯ä»¥å°†ä»¥ä¸‹ä¾èµ–æ·»åŠ åˆ°æ‚¨çš„é¡¹ç›®çš„ pom.xml æ–‡ä»¶ä¸­ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

ä¸€æ—¦ Redis çš„ä¾èµ–è¢«æ·»åŠ ï¼Œæ‚¨éœ€è¦é…ç½® Redis çš„ç›¸å…³ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ Redis é…ç½®ï¼š

```yaml
spring:
  redis:
    host: 127.0.0.1
    port: 6379
    password: 
    database: 0
```

åœ¨ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ï¼Œhost å’Œ port å±æ€§æŒ‡å®šäº† Redis æœåŠ¡å™¨çš„ä¸»æœºåå’Œç«¯å£å·ï¼Œpassword å±æ€§ç”¨äºæŒ‡å®š Redis æœåŠ¡å™¨çš„å¯†ç ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œè€Œ database å±æ€§åˆ™æŒ‡å®šäº† Redis æœåŠ¡å™¨ä½¿ç”¨çš„æ•°æ®åº“ç¼–å·ã€‚

Redis çš„é»˜è®¤åºåˆ—åŒ–å™¨æ˜¯ JdkSerializationRedisSerializerï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œç”±äºå…¶åºåˆ—åŒ–åçš„å¤§å°é€šå¸¸æ¯”è¾ƒå¤§ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ StringRedisSerializer æˆ–è€… Jackson2JsonRedisSerializer å°†ç¼“å­˜å€¼åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²æˆ–è€… JSON æ ¼å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰åºåˆ—åŒ–å™¨çš„ç¤ºä¾‹ï¼š

```java
@Configuration
public class RedisConfig {
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<String, Object>();
        template.setConnectionFactory(connectionFactory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new Jackson2JsonRedisSerializer<>(Object.class));
        return template;
    }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰ Bean é…ç½®äº† RedisTemplateï¼Œä½¿ç”¨ StringRedisSerializer åºåˆ—åŒ– Redis é”®ï¼Œå¹¶ä½¿ç”¨ Jackson2JsonRedisSerializer åºåˆ—åŒ– Redis å€¼ä¸º JSON æ ¼å¼ã€‚

## Cacheable æ³¨è§£

ä½¿ç”¨ Cacheable æ³¨è§£æ¥æ ‡è®°éœ€è¦è¿›è¡Œç¼“å­˜çš„æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…·æœ‰ Cacheable æ³¨è§£çš„ç¤ºä¾‹æ–¹æ³•ï¼š

```java
@Service
public class UserService {
    @Cacheable(value = "users", key = "#id")
    public User getUserById(Long id) {
        // æŸ¥è¯¢ç”¨æˆ·å¹¶è¿”å›
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ@Cacheable æ³¨è§£ç”¨äºæ ‡è®° getUserById æ–¹æ³•ï¼Œè€Œ value å±æ€§åˆ™ç”¨äºæŒ‡å®šç¼“å­˜çš„å­˜å‚¨åŒºåŸŸçš„åç§°ã€‚ç”±äºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ Redis ä½œä¸ºç¼“å­˜ï¼Œå› æ­¤ Redis ä¸­çš„ key å°†ç”± Cacheable æ³¨è§£ä¸­çš„ key å±æ€§æŒ‡å®šã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œkey å±æ€§è®¾ç½®ä¸º "#id"ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†ä½¿ç”¨æ–¹æ³•å‚æ•° id ä½œä¸º Redis ç¼“å­˜çš„é”®ã€‚

## å¤šå‚æ•° Cacheable æ³¨è§£

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä»¥å¤šä¸ªå‚æ•°ä½œä¸º key æ¥ç¼“å­˜æ•°æ®ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ key å±æ€§ä½¿ç”¨è¡¨è¾¾å¼ languageï¼ˆSpELï¼‰æ¥è®¾ç½®å¤šä¸ªå‚æ•°ï¼š

```java
@Service
public class UserService {
    @Cacheable(value = "users", key = "#id + '_' + #name")
    public User getUserByIdAndName(Long id, String name) {
        // æŸ¥è¯¢ç”¨æˆ·å¹¶è¿”å›
    }
}
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰å°† id å’Œ name ä¸¤ä¸ªå‚æ•°ç»„åˆæˆäº†ä¸€ä¸ª Redis ç¼“å­˜é”®ã€‚

## ç¼“å­˜çš„æœ‰æ•ˆæœŸ

ç¼“å­˜çš„æœ‰æ•ˆæœŸå®é™…ä¸Šæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œå¯¹äºç¼“å­˜çš„æ€§èƒ½å’Œå¯é æ€§éƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚å¯ä»¥ä½¿ç”¨ `@Cacheable` æ³¨è§£ä¸Šçš„ `expire` å±æ€§æ¥è®¾ç½®ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªè®¾ç½®ç¼“å­˜æ—¶æ•ˆçš„ç¤ºä¾‹ï¼š

```java
@Service
public class UserService {
    @Cacheable(value = "users", key = "#id", expire = 600)
    public User getUserById(Long id) {
        // æŸ¥è¯¢ç”¨æˆ·å¹¶è¿”å›
    }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªåä¸º expire çš„å±æ€§ï¼Œè¯¥å±æ€§ç”¨äºæŒ‡å®šç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 600 ç§’ï¼Œä¹Ÿå°±æ˜¯ 10 åˆ†é’Ÿã€‚


## ç¼“å­˜çš„æ¸…é™¤ @CacheEvict

æœ‰æ—¶å€™ï¼Œæ‚¨éœ€è¦æ¸…é™¤ Redis ç¼“å­˜ä¸­çš„æŸäº›æ•°æ®ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡è®¿é—®æ—¶é‡å»ºç¼“å­˜ã€‚åœ¨ Spring Boot ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ @CacheEvict æ³¨è§£æ¥æ¸…é™¤ Redis ç¼“å­˜ä¸­çš„æ•°æ®ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ @CacheEvict æ³¨è§£çš„ç¤ºä¾‹ï¼š

```java
@Service
public class UserService {
    @Cacheable(value = "users", key = "#id")
    public User getUserById(Long id) {
        // æŸ¥è¯¢ç”¨æˆ·å¹¶è¿”å›
    }

    @CacheEvict(value = "users", key = "#id")
    public void deleteUserById(Long id) {
        // åˆ é™¤ç”¨æˆ·å¹¶è¿”å›
    }

    @CacheEvict(value = "users", allEntries = true)
    public void deleteAllUsers() {
        // åˆ é™¤æ‰€æœ‰ç”¨æˆ·å¹¶è¿”å›
    }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†åˆ é™¤å•ä¸ªç”¨æˆ·å’Œåˆ é™¤æ‰€æœ‰ç”¨æˆ·çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨ @CacheEvict æ³¨è§£æ¥åˆ é™¤ Redis ç¼“å­˜ä¸­çš„ç›¸åº”æ•°æ®ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è®¾ç½®äº† allEntries å±æ€§ä¸º trueï¼Œä»¥åˆ é™¤æ‰€æœ‰ç¼“å­˜ä¸­çš„æ•°æ®ã€‚

## ç¼“å­˜çš„æ¡ä»¶

æœ‰æ—¶å€™ï¼Œæ‚¨éœ€è¦åœ¨æŸäº›ç‰¹å®šæ¡ä»¶ä¸‹æ‰è¿›è¡Œç¼“å­˜æ“ä½œã€‚ä¾‹å¦‚ï¼Œåªæœ‰å½“ç”¨æˆ·å¹´é¾„å¤§äº 18 å²æ—¶æ‰è¿›è¡Œç¼“å­˜ã€‚åœ¨ Spring Boot ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ @Cacheableã€@CachePut å’Œ @CacheEvict æ³¨è§£ä¸Šçš„ condition å±æ€§æ¥è®¾ç½®ç¼“å­˜æ¡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ condition å±æ€§çš„ç¤ºä¾‹ï¼š

```java
@Service
public class UserService {
    @Cacheable(value = "users", key = "#id", condition = "#age > 18")
    public User getUserById(Long id, int age) {
        // æŸ¥è¯¢ç”¨æˆ·å¹¶è¿”å›
    }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªåä¸º condition çš„å±æ€§ï¼Œè¯¥å±æ€§ç”¨äºæŒ‡å®šç¼“å­˜çš„æ¡ä»¶ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† condition å±æ€§è®¾ç½®ä¸º "#age > 18"ï¼Œè¿™æ„å‘³ç€åªæœ‰å½“ age å¤§äº 18 æ—¶ï¼Œæ‰è¿›è¡Œç¼“å­˜æ“ä½œã€‚

## ç¼“å­˜ç®¡ç†

åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œåº”ç”¨ç¨‹åºç¼“å­˜æ•°æ®çš„ç®¡ç†ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚Spring Boot æä¾›äº†ä¸€ä¸ªåä¸º CacheManager çš„æ¥å£ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥åˆ›å»ºå¹¶ç®¡ç†ç¼“å­˜å¯¹è±¡ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ CacheManager çš„ç¤ºä¾‹ï¼š

```java
@Configuration
@EnableCaching
public class CacheConfig extends CachingConfigurerSupport {
    @Bean
    @Override
    public CacheManager cacheManager() {
        RedisCacheManager cacheManager = RedisCacheManager.builder(redisConnectionFactory())
                .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(10)))
                .build();
        return cacheManager;
    }

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory("localhost", 6379);
    }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º CacheConfig çš„é…ç½®ç±»ï¼Œå¹¶ä½¿ç”¨ @EnableCaching æ³¨è§£æ¥å¼€å¯ç¼“å­˜æ”¯æŒã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡å®ç° CachingConfigurerSupport æ¥å£ï¼Œè¦†ç›– cacheManager æ–¹æ³•ï¼Œåˆ›å»ºäº†ä¸€ä¸ª RedisCacheManager å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿”å›ã€‚åœ¨æ­¤ RedisCacheManager ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„ RedisCacheConfiguration è¿›è¡Œäº†ä¸€äº›é…ç½®ï¼Œä¾‹å¦‚è®¾ç½®ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼ŒåŒæ—¶æŒ‡å®šäº† Redis çš„è¿æ¥ä¿¡æ¯ã€‚

## ç»“è¯­

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•åœ¨ Spring Boot åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ Redis è¿›è¡Œç¼“å­˜ã€‚æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•é€šè¿‡è‡ªå®šä¹‰ RedisTemplate Bean æ¥é…ç½®è‡ªå·±çš„ Redis åºåˆ—åŒ–å™¨ï¼Œåœ¨ Cacheable æ³¨è§£ä¸­æŒ‡å®šç¼“å­˜åŒºåŸŸå’Œç¼“å­˜é”®ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ @CacheEvict æ–¹æ³•æ¥æ¸…é™¤ Redis ç¼“å­˜ä¸­çš„æ•°æ®ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å±•ç¤ºäº†æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿ç”¨ CacheManager å¯¹è±¡ç®¡ç†ç¼“å­˜ã€‚

![](https://files.mdnice.com/user/33663/cbff779f-c976-4135-9b93-ba208a5b0624.png)

å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼šâ€œå°è™å“¥çš„æŠ€æœ¯åšå®¢â€ã€‚æˆ‘ä»¬ä¼šå®šæœŸå‘å¸ƒå…³äºJavaæŠ€æœ¯çš„è¯¦å°½æ–‡ç« ï¼Œè®©æ‚¨èƒ½å¤Ÿæ·±å…¥äº†è§£è¯¥é¢†åŸŸçš„å„ç§æŠ€å·§å’Œæ–¹æ³•ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æˆä¸ºæ›´ä¼˜ç§€çš„ç¨‹åºå‘˜ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»ï¼

ç›¸å…³æ–‡ç« æºç æ”¾åœ¨ï¼š[giteeä»“åº“](https://gitee.com/cunzaizhe/xiaohuge-blog)ã€[githubä»“åº“](https://github.com/tigerleeli/xiaohuge-blog)ä¸Šã€‚